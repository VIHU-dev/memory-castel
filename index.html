<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Castelo da Mem√≥ria</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #111;
      color: white;
      overflow: hidden;
    }

    canvas {
      display: block;
      margin: 0 auto;
      background: #1e1e1e;
      border: 4px solid #d4af37;
    }

    #menu {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 2;
    }

    #menu h1 {
      font-size: 3em;
      margin-bottom: 20px;
      color: #d4af37;
    }

    #menu button {
      padding: 15px 30px;
      font-size: 18px;
      background-color: #d4af37;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.3s;
    }

    #menu button:hover {
      background-color: #b9982e;
    }

    #dialogo {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      font-size: 16px;
      color: #fff;
      font-style: italic;
      text-align: center;
      z-index: 3;
      display: none;
    }
  </style>
</head>
<body>
  <div id="menu">
    <h1>üè∞ Castelo da Mem√≥ria</h1>
    <button onclick="startGame()">Novo Jogo</button>
  </div>

  <div id="dialogo">Bem-vindo ao castelo...</div>
  <canvas id="game" width="640" height="480"></canvas>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const dialogo = document.getElementById("dialogo");
let gameRunning = false;

// M√∫sica tema (gerada por Web Audio API)
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function tocarMusica() {
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'triangle';
  o.frequency.setValueAtTime(220, audioCtx.currentTime);
  g.gain.setValueAtTime(0.1, audioCtx.currentTime);
  o.connect(g);
  g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + 1.5);
}

// Estados e vari√°veis principais
let keys = {};
let level = 1;
let player = {
  x: 2, y: 2,
  vida: 5,
  maxVida: 5,
  cor: "#ffe",
  facing: "down",
  moving: false,
  draw() {
    // Corpo
    ctx.fillStyle = this.cor;
    ctx.beginPath();
    ctx.arc(this.x * 32 + 16, this.y * 32 + 20, 10, 0, Math.PI * 2);
    ctx.fill();
    // Cabe√ßa
    ctx.fillStyle = "#ffccaa";
    ctx.beginPath();
    ctx.arc(this.x * 32 + 16, this.y * 32 + 8, 6, 0, Math.PI * 2);
    ctx.fill();
    // Olhos
    ctx.fillStyle = "#000";
    ctx.beginPath();
    ctx.arc(this.x * 32 + 14, this.y * 32 + 7, 1.5, 0, Math.PI * 2);
    ctx.arc(this.x * 32 + 18, this.y * 32 + 7, 1.5, 0, Math.PI * 2);
    ctx.fill();
  }
};

let mapa = [
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1],
  [1,0,1,1,0,1,1,0,1,1,1,1,0,1,1,0,1,0,0,1],
  [1,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,1,0,0,1],
  [1,0,1,0,1,1,0,1,1,1,0,1,1,0,1,0,1,0,0,1],
  [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,3,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

function startGame() {
  document.getElementById("menu").style.display = "none";
  gameRunning = true;
  tocarMusica();
  requestAnimationFrame(loop);
}

document.addEventListener("keydown", (e) => {
  keys[e.key.toLowerCase()] = true;
});
document.addEventListener("keyup", (e) => {
  keys[e.key.toLowerCase()] = false;
});
let inimigos = [
  { x: 5, y: 1, vida: 3, ativo: true },
  { x: 15, y: 4, vida: 2, ativo: true }
];

let princesa = { x: 18, y: 5, salva: false };

let po√ß√µes = [{ x: 3, y: 3, usada: false }];

function desenharMapa() {
  for (let y = 0; y < mapa.length; y++) {
    for (let x = 0; x < mapa[0].length; x++) {
      let bloco = mapa[y][x];
      ctx.fillStyle = bloco === 1 ? "#444" : "#ccc";
      ctx.fillRect(x * 32, y * 32, 32, 32);
    }
  }
}

function desenharInimigos() {
  for (let i of inimigos) {
    if (!i.ativo) continue;
    ctx.fillStyle = "#c00";
    ctx.beginPath();
    ctx.arc(i.x * 32 + 16, i.y * 32 + 16, 10, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = "#000";
    ctx.fillRect(i.x * 32 + 12, i.y * 32 + 12, 4, 4); // olhos
  }
}

function desenharPrincesa() {
  if (princesa.salva) return;
  ctx.fillStyle = "#fdd";
  ctx.beginPath();
  ctx.arc(princesa.x * 32 + 16, princesa.y * 32 + 16, 10, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = "#ff0";
  ctx.fillRect(princesa.x * 32 + 12, princesa.y * 32 + 5, 8, 4); // coroa
}

function desenharPocoes() {
  for (let p of po√ß√µes) {
    if (p.usada) continue;
    ctx.fillStyle = "#0f0";
    ctx.beginPath();
    ctx.arc(p.x * 32 + 16, p.y * 32 + 16, 6, 0, Math.PI * 2);
    ctx.fill();
  }
}

function desenharHUD() {
  ctx.fillStyle = "#000";
  ctx.fillRect(0, 0, canvas.width, 24);
  ctx.fillStyle = "#fff";
  ctx.font = "16px sans-serif";
  ctx.fillText("Vida: " + player.vida + "/" + player.maxVida + " | N√≠vel: " + level, 10, 18);
}

function checarCombate() {
  for (let i of inimigos) {
    if (!i.ativo) continue;
    if (i.x === player.x && i.y === player.y) {
      i.vida -= 1;
      player.vida -= 1;
      dialogo.innerText = "‚öîÔ∏è Combate!";
      dialogo.style.display = "block";
      setTimeout(() => dialogo.style.display = "none", 1000);
      if (i.vida <= 0) i.ativo = false;
    }
  }
}
function mover(dx, dy) {
  const novoX = player.x + dx;
  const novoY = player.y + dy;

  if (mapa[novoY][novoX] !== 1) {
    player.x = novoX;
    player.y = novoY;
    checarCombate();
    checarInteracoes();
  }
}

let tempoMov = 0;
function atualizarEntrada() {
  tempoMov--;
  if (tempoMov > 0) return;

  if (keys["w"]) { mover(0, -1); player.facing = "up"; tempoMov = 10; }
  else if (keys["s"]) { mover(0, 1); player.facing = "down"; tempoMov = 10; }
  else if (keys["a"]) { mover(-1, 0); player.facing = "left"; tempoMov = 10; }
  else if (keys["d"]) { mover(1, 0); player.facing = "right"; tempoMov = 10; }
}

function checarInteracoes() {
  // Po√ß√£o
  for (let p of po√ß√µes) {
    if (!p.usada && player.x === p.x && player.y === p.y) {
      player.vida = Math.min(player.maxVida, player.vida + 2);
      p.usada = true;
      dialogo.innerText = "Voc√™ tomou uma po√ß√£o üçµ";
      dialogo.style.display = "block";
      setTimeout(() => dialogo.style.display = "none", 1000);
    }
  }

  // Princesa
  if (!princesa.salva && player.x === princesa.x && player.y === princesa.y) {
    princesa.salva = true;
    dialogo.innerText = "üë∏ Voc√™ salvou a princesa!";
    dialogo.style.display = "block";
    setTimeout(() => {
      dialogo.style.display = "none";
      vitoria();
    }, 2000);
  }
}

function vitoria() {
  gameRunning = false;
  setTimeout(() => {
    alert("üèÜ Parab√©ns! Voc√™ venceu!\nNew Game+ ativado.");
    reiniciarJogo();
  }, 100);
}

function reiniciarJogo() {
  level++;
  player.x = 2;
  player.y = 2;
  player.vida = player.maxVida;
  princesa.salva = false;
  po√ß√µes = [{ x: 3, y: 3, usada: false }];
  inimigos = [
    { x: 5, y: 1, vida: 2 + level, ativo: true },
    { x: 15, y: 4, vida: 2 + level, ativo: true }
  ];
  gameRunning = true;
  requestAnimationFrame(loop);
}

function loop() {
  if (!gameRunning) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  desenharMapa();
  desenharPocoes();
  desenharPrincesa();
  desenharInimigos();
  player.draw();
  desenharHUD();
  atualizarEntrada();

  if (player.vida <= 0) {
    dialogo.innerText = "üíÄ Voc√™ morreu!";
    dialogo.style.display = "block";
    gameRunning = false;
    setTimeout(() => {
      alert("Game Over! Reiniciando...");
      reiniciarJogo();
    }, 1500);
    return;
  }

  requestAnimationFrame(loop);
}
</script>
</body>
</html>
