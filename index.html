<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Castelo da Mem√≥ria 2D</title>
  <style>
    body {
      margin: 0;
      background: #111;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    canvas {
      border: 3px solid #fff;
      image-rendering: pixelated;
    }

    #popup {
      position: absolute;
      background: white;
      border: 2px solid #333;
      border-radius: 10px;
      padding: 20px;
      display: none;
      flex-direction: column;
      gap: 10px;
      width: 300px;
      z-index: 10;
    }

    textarea {
      width: 100%;
      height: 100px;
      resize: none;
      font-size: 14px;
    }

    .buttons {
      display: flex;
      justify-content: space-between;
    }

    button {
      padding: 5px 10px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="416" height="416"></canvas>

  <div id="popup">
    <h3 id="popupTitle"></h3>
    <textarea id="memoryText" placeholder="Escreva sua mem√≥ria aqui..."></textarea>
    <div class="buttons">
      <button onclick="saveMemory()">Salvar</button>
      <button onclick="closePopup()">Fechar</button>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const tileSize = 32;

    const map = [
      "############",
      "#....T.....#",
      "#..####....#",
      "#..#..#....#",
      "#..#..#....#",
      "#..####..J.#",
      "#....S.....#",
      "############"
    ];

    const player = { x: 1, y: 1, color: "#FFD700" };

    function drawMap() {
      for (let y = 0; y < map.length; y++) {
        for (let x = 0; x < map[y].length; x++) {
          const tile = map[y][x];
          ctx.fillStyle = tile === "#" ? "#444" : "#ccc";
          ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);

          // Destacar locais especiais
          if (tile === "T") drawSymbol(x, y, "üëë");
          if (tile === "J") drawSymbol(x, y, "üå∏");
          if (tile === "S") drawSymbol(x, y, "üìñ");
        }
      }
    }

    function drawSymbol(x, y, emoji) {
      ctx.font = "20px Arial";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(emoji, x * tileSize + tileSize / 2, y * tileSize + tileSize / 2);
    }

    function drawPlayer() {
      ctx.fillStyle = player.color;
      ctx.fillRect(player.x * tileSize, player.y * tileSize, tileSize, tileSize);
    }

    function update() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawMap();
      drawPlayer();
    }

    function canMove(x, y) {
      const tile = map[y]?.[x];
      return tile && tile !== "#";
    }

    function checkMemoryTile() {
      const tile = map[player.y][player.x];
      const memoryMap = {
        "T": "Sala do Trono üëë",
        "J": "Jardim das Lembran√ßas üå∏",
        "S": "Sala dos Segredos üìñ"
      };

      if (memoryMap[tile]) {
        openPopup(memoryMap[tile], tile);
      }
    }

    document.addEventListener("keydown", (e) => {
      let nx = player.x;
      let ny = player.y;

      if (e.key === "ArrowUp") ny--;
      if (e.key === "ArrowDown") ny++;
      if (e.key === "ArrowLeft") nx--;
      if (e.key === "ArrowRight") nx++;

      if (canMove(nx, ny)) {
        player.x = nx;
        player.y = ny;
        update();
        checkMemoryTile();
      }
    });

    // --- POPUP ---
    let currentKey = "";

    function openPopup(title, key) {
      currentKey = key;
      document.getElementById("popupTitle").textContent = title;
      document.getElementById("memoryText").value = localStorage.getItem(key) || "";
      document.getElementById("popup").style.display = "flex";
    }

    function closePopup() {
      document.getElementById("popup").style.display = "none";
    }

    function saveMemory() {
      const text = document.getElementById("memoryText").value;
      localStorage.setItem(currentKey, text);
      alert("Mem√≥ria salva com sucesso!");
      closePopup();
    }

    update();
  </script>
</body>
</html>
