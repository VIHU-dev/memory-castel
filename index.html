<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Castelo da Mem√≥ria - A Jornada</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #000; font-family: sans-serif; overflow: hidden; }
    canvas { display: block; margin: auto; background: #222; image-rendering: pixelated; }
    #menu {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(to bottom, #d4af37, #7b4c20);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 20px;
      z-index: 10;
    }
    #menu h1 { font-size: 3em; color: #fff; text-shadow: 2px 2px #000; }
    button {
      font-size: 1.5em; padding: 10px 20px; border: none;
      border-radius: 10px; cursor: pointer;
    }
    #startButton { background: #fff; }
    #startButton:hover { background: #ccc; }
    #dialogBox {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      color: #000;
      padding: 10px 15px;
      border-radius: 10px;
      font-size: 1em;
      display: none;
      max-width: 80%;
    }
  </style>
</head>
<body>
<div id="menu">
  <h1>üè∞ Castelo da Mem√≥ria</h1>
  <button id="startButton">Novo Jogo</button>
</div>
<canvas id="game" width="640" height="480"></canvas>
<div id="dialogBox"></div>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const tileSize = 32;
const cols = 20;
const rows = 15;

let level = 1;
let playing = false;
let inCombat = false;
let defeated = 0;

const player = { x: 2, y: 2, hp: 5, maxHp: 5, color: "#44f", inventory: [] };

let keys = {};
let map = [];
let monsters = [];
let items = [];
let dialogQueue = [];
let dialogBox = document.getElementById("dialogBox");

let princess = { x: 18, y: 13, rescued: false };

function createMap() {
  map = [];
  for (let y = 0; y < rows; y++) {
    let row = [];
    for (let x = 0; x < cols; x++) {
      if (x === 0 || y === 0 || x === cols - 1 || y === rows - 1) row.push(1);
      else row.push(0);
    }
    map.push(row);
  }
  map[princess.y][princess.x] = 2;
  spawnItems();
}

function spawnMonsters(num) {
  monsters = [];
  for (let i = 0; i < num; i++) {
    let mx = Math.floor(Math.random() * (cols - 2)) + 1;
    let my = Math.floor(Math.random() * (rows - 2)) + 1;
    if (map[my][mx] === 0 && (mx !== player.x || my !== player.y)) {
      monsters.push({ x: mx, y: my, hp: 2 + level });
    }
  }
}

function spawnItems() {
  items = [];
  for (let i = 0; i < 2; i++) {
    let ix = Math.floor(Math.random() * (cols - 2)) + 1;
    let iy = Math.floor(Math.random() * (rows - 2)) + 1;
    if (map[iy][ix] === 0) items.push({ x: ix, y: iy, type: 'potion' });
  }
}

function canMove(x, y) {
  return map[y] && map[y][x] === 0 && !monsters.some(m => m.x === x && m.y === y);
}

function drawMap() {
  for (let y = 0; y < rows; y++) {
    for (let x = 0; x < cols; x++) {
      if (map[y][x] === 1) ctx.fillStyle = "#654321";
      else if (map[y][x] === 2) ctx.fillStyle = "pink";
      else ctx.fillStyle = "#f5f0e6";
      ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
    }
  }
}

function drawPlayer() {
  ctx.fillStyle = player.color;
  ctx.beginPath();
  ctx.arc(
    player.x * tileSize + tileSize / 2,
    player.y * tileSize + tileSize / 2,
    tileSize / 2 - 4,
    0, Math.PI * 2
  );
  ctx.fill();
}

function drawMonsters() {
  for (const m of monsters) {
    ctx.fillStyle = "red";
    ctx.fillRect(m.x * tileSize + 8, m.y * tileSize + 8, tileSize - 16, tileSize - 16);
  }
}

function drawItems() {
  for (const i of items) {
    ctx.fillStyle = "green";
    ctx.beginPath();
    ctx.arc(i.x * tileSize + 16, i.y * tileSize + 16, 6, 0, Math.PI * 2);
    ctx.fill();
  }
}

function drawUI() {
  ctx.fillStyle = "white";
  ctx.fillText(`HP: ${player.hp} | Inimigos: ${monsters.length} | Itens: ${player.inventory.length}`, 10, 15);
}

function combat(monster) {
  inCombat = true;
  monster.hp--;
  if (monster.hp <= 0) {
    monsters = monsters.filter(m => m !== monster);
    defeated++;
    showDialog("Voc√™ derrotou um monstro!");
  } else {
    player.hp--;
    showDialog("Voc√™ foi atingido!");
    if (player.hp <= 0) gameOver();
  }
  inCombat = false;
}

function gameOver() {
  alert("Game Over! Tentativas: " + level);
  level = 1;
  player.hp = player.maxHp;
  defeated = 0;
  princess.rescued = false;
  startGame();
}

function checkVictory() {
  if (player.x === princess.x && player.y === princess.y) {
    princess.rescued = true;
    showDialog("Voc√™ encontrou a princesa! üéâ");
    setTimeout(() => {
      level++;
      player.hp = player.maxHp;
      startGame();
    }, 2000);
  }
}

function checkItems() {
  const index = items.findIndex(i => i.x === player.x && i.y === player.y);
  if (index !== -1) {
    const item = items.splice(index, 1)[0];
    player.inventory.push(item);
    if (item.type === 'potion') {
      player.hp = Math.min(player.hp + 2, player.maxHp);
      showDialog("Voc√™ usou uma po√ß√£o! +2 HP");
    }
  }
}

function update() {
  if (!playing || inCombat) return;

  let dx = 0, dy = 0;
  if (keys["ArrowUp"] || keys["w"]) dy = -1;
  else if (keys["ArrowDown"] || keys["s"]) dy = 1;
  else if (keys["ArrowLeft"] || keys["a"]) dx = -1;
  else if (keys["ArrowRight"] || keys["d"]) dx = 1;

  if (dx !== 0 || dy !== 0) {
    const nx = player.x + dx;
    const ny = player.y + dy;
    if (canMove(nx, ny)) {
      player.x = nx;
      player.y = ny;
      checkItems();
    } else {
      const monster = monsters.find(m => m.x === nx && m.y === ny);
      if (monster) combat(monster);
    }
    checkVictory();
    keys = {}; // uma etapa por clique
  }
}

function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawMap();
  drawPlayer();
  drawMonsters();
  drawItems();
  drawUI();
}

function loop() {
  update();
  render();
  requestAnimationFrame(loop);
}

document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

document.getElementById("startButton").addEventListener("click", () => {
  document.getElementById("menu").style.display = "none";
  playMusic();
  startGame();
});

function startGame() {
  playing = true;
  princess.x = 18; princess.y = 13; princess.rescued = false;
  player.x = 2; player.y = 2; player.inventory = [];
  createMap();
  spawnMonsters(2 + level);
  loop();
}

function showDialog(text) {
  dialogBox.textContent = text;
  dialogBox.style.display = 'block';
  setTimeout(() => { dialogBox.style.display = 'none'; }, 2000);
}

function playMusic() {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  osc.type = "triangle";
  osc.frequency.setValueAtTime(220, ctx.currentTime);
  const gain = ctx.createGain();
  gain.gain.setValueAtTime(0.05, ctx.currentTime);
  osc.connect(gain).connect(ctx.destination);
  osc.start(); osc.stop(ctx.currentTime + 3);
}
</script>
</body>
</html>
